## 서버 기능 명세 문서
<a href = "https://www.notion.so/285e8386fa6880f486a7e3a9d57e21cf?source=copy_link"><h3>Click Me</h3></a>

<br>

## 자동 빌드
### `./gradlew build --continuous`

## 자동 실행
### `./gradlew bootRun`

<br>

## 날씨 지점 정보
- 지상관측
STN: 133  
LON: 127.37210000   
LAT: 36.37199000  
STN_SP: 45201        
HT: 67.79     
HT_PA: 68.49      
HT_TA: 1.40     
HT_WD: 23.70      
HT_RN: 1.00  
STN: 133  
STN_KO: 대전                 
STN_EN: Daejeon  
FCT_ID: 11C20401  
LAW_ID: 3020012400  

- 단기 예보
REG_ID(보구역코드, 대전) : 11C20401   

# 5. 데이터 생성

## 5.1. 시뮬레이션 대상 빌딩 정보

비교 대상이 될 타 빌딩들의 베이스 정보가 될 것임.

### 5.1.1. 빌딩 개요

- 빌딩 이름 : 토리 빌딩
- 소재지 : 대전광역시
- 층수 : 4층
- 주요 용도 : IT 교육
- 전체 운영 시간 : 월~금, 08:00 ~ 21:00
- 피크 운영 시간 : 월~금, 09:00 ~ 18:00
- 특이사항
    - 5개 강의실을 운영 중이며, 동시에 최대 5개의 교육과정이 진행될 수 있다.
        - 각 교육과정은 1개월 또는 6개월씩 진행된다.
        - 하나의 교육과정이 종료되고 짧게는 1주일에서 6개월 정도의 텀을 두고 다음 과정이 시작된다.
        - 따라서 항상 5개 강의실이 모두 사용되는 것은 아니다.
    - 사용 인원과 운영시간 중 사용 시간 비율은 다음과 같다.
        - 고정 직원 6~7명 : 90 ~ 100%
        - 교육과정 당 10~15명(강사 1명 포함) : 80 ~ 100%
        - 불규칙적인 외부 방문객 10 ~ 50명(주로 20 ~ 35명) : 5 ~ 10%

### 5.1.2. 층별 상세 정보

| 층 | 주요 용도 | 상주 인원 | 컴퓨터 | 조명 | 냉난방기 | 비고 |
| --- | --- | --- | --- | --- | --- | --- |
| 1층 | 사무실 | 6~7명 | 9대 | 18개 | 2대 | 불규칙 외부 방문객의 95%가 이 층을 사용. |
| 2층 | 강의실 | 20~30명 | 80대 | 23개 | 2대 | 강의실 2개, 강의실 당 10 ~ 15명 사용. |
| 3층 | 강의실 | 20~30명 | 80대 | 23개 | 2대 | 강의실 2개, 강의실 당 10 ~ 15명 사용. |
| 4층 | 강의실 | 10~15명 | 25대 | 14개 | 1대 | 강의실 1개, 강의실 당 10 ~ 15명 사용. |

### 5.1.3. 공용 시설

- 화장실 : 모든 층에 남/녀 화장실 각 1개소씩 있다.
- 엘리베이터 : 1대
- 보일러 : 1대
    - 보일러 1대가 빌딩 전체에 사용되며, 따라서 가스 사용량을 빌딩 전체로 계산함
    - 가스 사용량은 이 보일러 사용량과 100% 일치한다.(조리기구 없음)

## 5.2. 시뮬레이션 항목

### 5.2.1. 전력 사용량 생성

- 장비 상태가 on인 장비만 전력 사용량을 생성한다.
- (켜진 컴퓨터 수 * 사용 전력량) + (켜진 냉난방기 수 * 사용 전력량) + (켜진 조명 수 * 사용 전력량) = 층 또는 전체 사용 전력량
    - 사용 전력량은 각 장비별 10초 마다 사용되는 전력량이다.
- 사용량 단위는 kWh이다.

### 5.2.2. 수도 사용량 생성

- 층별 사용인원을 고려하여 수도 사용량을 계산한다.
- 시간 및 계절별 사용량 변화를 준다.
    - 출근/퇴근/점심시간 등 인원 변동이 잦은 시간대에 사용량 변화를 반영한다.
- 사용량 단위는 ㎥이다.

### 5.2.3. 가스 사용량 생성

- 빌딩 사용인원을 고려하여 수도 사용량을 계산한다.
- 시간 및 계절별 사용량 변화를 준다.
    - 점심시간대 온수 사용량 증가 인한 사용량 변화를 반영한다.
- 사용량 단위는 ㎥이다.

### 5.2.4. 현실감 있는 다채로운 데이터 생성

- 실제 IOT 장비의 센서 데이터가 없는 개발 환경을 위해 실시간 사용 패턴과 유사한 에너지 데이터를 생성한다.
- 계절, 시간대, 특별 상황 등 다양한 변수를 고려하여 현실성이 높은 데이터를 시뮬레이션한다.
- 랜덤한 변동성을 추가한다.
    - 모든 계산된 값에 일정 범위(+- 5%)의 랜덤 노이즈를 추가하여 일관적이지 않은 실제 사용 패턴을 모방한다.
    - 낮은 확률로 다음과 같은 이벤트를 시뮬레이션하여 데이터의 현실감을 더한다.
        - 회의로 인한 냉난방기 추가 가동
        - 야근으로 인한 야간 전력 사용량 급증
        - 외부 인원 인원 급증
        - 일부 강의실 하루 휴강
        - 강의 종료가 다가올수록 학생수 감소
        - 강의 시작 전 상담인원(외부인원) 증가
        - 등 최소 10개의 다채로운 이벤트 생성
- 서버가 실행되어 있는 동안 10초마다 각 사용량 데이터를 생성하고 5분마다 데이터베이스에 저장한다.
- 서버가 최초 시작되었을 때 지난 3년치의 사용량 데이터를 생성한다.
- 서버가 시작되면 지난 1년치 사용량 데이터를 확인하고, 누락된 데이터가 있을 경우 규칙에 맞게 임의 데이터를 채워 넣는다.

### 5.2.5. 비교 빌딩 데이터 생성

이 빌딩의 사용 목적과 사용인원, 빌딩 규모가 비슷한 타 빌딩의 전력, 가스, 수도 데이터를 생성한다.
  

에너지 사용량
    - 아이디
    - 측정 빌딩 아이디
    - 에너지 타입
	- 측정 시간
	- 사용량


- 전국(전체) 100개 빌딩 데이터를 생성한다.
    - 각 지역별(서울, 광역시, 도)로 다음을 고려해 빌딩 개수를 지정한다.
        - IT 직군 기업 비율
        - 인구수
    - 빌딩 이름과 주소는 임의로 짓는다.
    - 운영 시간은 08시 ~ 20시를 기준으로 하며, 1 ~ 3시간 정도 다르게 해도 된다.
    - 피크 시간은 09시 ~ 18시를 기준으로 하며, 1 ~ 2시간 정도 다르게 해도 된다.
    - 사용인원과 빌딩 규모, 각 장비의 개수는 이 빌딩의 +-20% 내로 한다.
- 각 사용량 데이터는 매시 정각에, 1시간 단위로 저장된다.
    - 다음을 고려하여 각 사용량 데이터를 생성한다.
        - 운영시간
        - 피크 운영 시간
        - 계절별 냉난방기/조명 사용 고려
    - 빌딩 당 3년치 데이터를 생성한다.
    - 사용량 데이터는 생성한 빌딩 데이터의 사용인원을 고려하여
    - 층과 장비는 고려하지 않고 빌딩 전체 사용량으로 계산한다.

<br>

# 6. 데이터 생성 기능 구현 로드맵

`DataGenerationService.java` 클래스에 시뮬레이션 데이터 생성 기능을 구현하기 위한 단계별 로드맵입니다.

## Phase 1: 기반 모델 및 설정 구축

- **1-1. 데이터 구조 정의:**
    - `Building`, `Floor`, `Device` 등 기존 엔티티를 활용하고, 비교군 빌딩 데이터 저장을 위한 새로운 엔티티 또는 DTO를 정의합니다.
    - 에너지 사용량(`ElectricityReading`, `GasReading`, `WaterReading`) 엔티티를 활용합니다.
- **1-2. `DataGenerationService` 클래스 생성:**
    - 데이터 생성 로직을 담당할 `@Service` 클래스를 생성합니다.
- **1-3. 상수 값 설정:**
    - `src/main/java/com/ThreeZem/three_zem_back/data/constant` 패키지 내에 장비별 소비 전력, 1인당 물 사용량 등 시뮬레이션에 필요한 상수 값들을 정의합니다.

## Phase 2: 메인 빌딩("토리 빌딩") 기본 데이터 생성

- **2-1. "토리 빌딩" 모델링:**
    - README에 명시된 층, 용도, 장비(컴퓨터, 조명, 냉난방기) 개수 정보를 바탕으로 빌딩의 구조를 메모리에 생성하는 로직을 구현합니다.
- **2-2. 핵심 사용량 계산 로직 구현:**
    - 시간 및 계절 변화를 제외한 기본 전력, 수도, 가스 사용량 계산 로직을 구현합니다.
    - 전력: `(켜진 장비 수 * 시간당 소비 전력)`
    - 수도/가스: `(상주 인원 * 시간당 평균 사용량)`
- **2-3. 스케줄러 설정:**
    - `@Scheduled` 어노테이션을 사용하여 10초마다 데이터 생성 메서드를 호출하는 스케줄러를 구현합니다.

## Phase 3: 현실성 및 시간적 변화 추가 (토리 빌딩)

- **3-1. 시간 기반 변화 구현:**
    - 운영 시간(08:00-21:00), 피크 시간(09:00-18:00), 주말 및 공휴일을 구분하여 사용량 패턴에 변화를 줍니다.
    - 출근, 점심, 퇴근 시간대의 인원 변동을 반영하여 수도 사용량에 변화를 줍니다.
- **3-2. 계절 기반 변화 구현:**
    - 여름철에는 냉난방기 사용량을 늘리고, 겨울철에는 가스(난방) 사용량을 늘리는 등 계절적 요인을 반영합니다.
- **3-3. 랜덤 변동성 추가:**
    - 계산된 모든 최종 값에 `+-5%` 범위의 랜덤 노이즈를 추가하여 예측 불가능한 실제 사용 패턴을 모방합니다.
- **3-4. 특수 이벤트 시뮬레이션:**
    - README에 명시된 10개 이상의 특수 상황(예: 회의, 야근, 휴강, 방문객 급증 등)을 리스트업하고, 낮은 확률로 랜덤하게 발생시켜 데이터의 현실감을 더하는 로직을 구현합니다.

## Phase 4: 데이터 영속성 및 이력 관리 (토리 빌딩)

- **4-1. 실시간 데이터 저장:**
    - 10초마다 생성된 데이터를 메모리에 보관하고, 5분마다 DB에 일괄 저장(`batch insert`)하는 로직을 구현합니다.
- **4-2. 과거 데이터 생성 (최초 실행):**
    - 애플리케이션이 처음 시작될 때, 지난 3년 치의 과거 사용량 데이터를 생성하여 DB에 저장하는 로직을 구현합니다. 이 작업은 `ApplicationRunner`를 활용하여 구현할 수 있습니다.
- **4-3. 누락 데이터 보완 (재실행 시):**
    - 애플리케이션 재시작 시, 지난 1년간의 데이터 중 누락된 부분이 있는지 확인하고, 규칙에 맞게 데이터를 채워 넣는 로직을 구현합니다.

## Phase 5: 비교군 빌딩 데이터 생성

- **5-1. 비교군 빌딩 생성 및 저장:**
    - IT 직군 비율, 인구수 등을 고려하여 전국 100개 빌딩의 위치를 분포시키고, `+-20%` 규모 편차를 적용하여 빌딩 정보를 생성한 후 DB에 저장합니다.
- **5-2. 비교군 빌딩 과거 데이터 생성:**
    - 생성된 100개 빌딩 각각에 대해, 운영 시간, 피크 시간, 계절적 요인을 고려하여 1시간 단위의 지난 3년 치 사용량(전력, 수도, 가스) 데이터를 생성하고 DB에 저장합니다. 이 로직은 빌딩 전체 사용량만 계산합니다.

## Phase 6: 통합 및 고도화

- **6-1. 서비스 통합:**
    - `DataGenerationService`가 애플리케이션의 생명주기에 맞게 적절히 호출되고 실행되는지 확인합니다.
- **6-2. 로깅 및 모니터링:**
    - 데이터 생성 과정의 주요 단계마다 로그를 추가하여 진행 상황과 발생 가능한 오류를 쉽게 추적할 수 있도록 합니다.
- **6-3. 코드 리팩토링 및 최적화:**
    - 특히 대량의 과거 데이터를 생성하는 로직의 성능을 검토하고 최적화합니다.
- **6-4. 단위 테스트 작성:**
    - 핵심 사용량 계산 로직, 랜덤 변동성 추가 등 주요 기능에 대한 단위 테스트를 작성하여 코드의 신뢰성을 확보합니다.